<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">

	<resultMap type="chatRoom" id="chatroom_rm">
	
		<id property="cmNo" column="CM_NO"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="inviteName" column="INVITE_NAME"/>
		<result property="status" column="STATUS"/>
	
	</resultMap>
	
	<resultMap type="message" id="message_rm">
		
		<id property="mNo" column="M_NO" />
		<id property="cmNo" column="CM_NO" />
		<id property="memNo" column="MEM_NO" />
		<id property="mContent" column="M_CONTENT" />
		<id property="mDate" column="M_DATE" />
		<id property="memberNick" column="MEMBER_NICK" />
		
	</resultMap>
	


<!-- 채팅방 리스트 조회 -->
	<select id="selectChatRoomList" resultMap="chatroom_rm">
		SELECT *
		FROM CHAT_ROOM
		JOIN CHAT_ROOM_JOIN USING (CM_NO)
		WHERE CHAT_ROOM_JOIN.MEM_NO = #{memNo}
		AND STATUS = 'Y'
		ORDER BY CM_NO
	</select>
	
<!-- 채팅 메세지 목록 조회 -->
	<select id="selectChatMessageList" resultMap="message_rm">
	 	SELECT M_NO,M_CONTENT, M_DATE, MEMBER_NICK, CM_NO
		FROM MESSAGE
		JOIN MEMBER USING (MEM_NO);
		WHERE CM_NO = ${cmNo}
		ORDER BY M_NO
	</select>
	
	<insert id="insertMessage">
		INSERT INTO MESSAGE VALUES(
		SEQ_CM_NO.NEXTVAL, #{cmNo}, #{memNo}, #{mContent}, DEFAULT, #{memberNick}
		)
	</insert>
	
	
	<insert id="createChatRoom">
		INSERT INTO CHAT_ROOM VALUES(SEQ_CR_NO.NEXTVAL, #{memNo}, #{inviteName}, DEFAULT)
	</insert>
	
	<insert id="createChatRoomJoin" parameterType="chatroom" useGeneratedKeys="true">
	    <selectKey keyProperty="cmNo" resultType="_int" order="BEFORE">
	        SELECT SEQ_CR_NO.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO CHAT_ROOM_JOIN VALUES(#{memNo}, #{cmNo})
	</insert>
	
		<insert id="inviteMember">
		INSERT INTO CHAT_ROOM_JOIN VALUES(#{memNo}, #{cmNo})
	</insert>
	
	
	
	


</mapper>
